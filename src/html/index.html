<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Расчёт по диапазону дат</title>
  <style>
    :root { --gap: 12px; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; }
    body { margin: 0; background: #0f172a; color: #e5e7eb; display: grid; place-items: center; min-height: 100dvh; }
    .card { width: min(720px, 92vw); background: #111827; border: 1px solid #1f2937; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { font-size: 20px; margin: 0 0 10px; color: #f3f4f6; }
    p.note { margin: 0 0 16px; color: #9ca3af; font-size: 14px; }
    form { display: grid; gap: var(--gap); grid-template-columns: 1fr 1fr auto; align-items: end; }
    label { display: grid; gap: 6px; font-size: 13px; color: #cbd5e1; }
    input[type="date"] { background:#0b1220; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:10px 12px; outline: none; }
    input[type="date"]:focus { border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.25); }
    button { height: 42px; padding: 0 16px; border: 0; border-radius: 10px; background: #2563eb; color: white; font-weight: 600; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .row { margin-top: 16px; display: grid; gap: var(--gap); }
    .out { white-space: pre-wrap; background: #0b1220; border:1px solid #1f2937; border-radius: 12px; padding: 12px; min-height: 80px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#c7d2fe; }
    .ok { color:#86efac; }
    .err { color:#fca5a5; }
    .small { font-size: 12px; color:#94a3b8; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Расчёт по диапазону дат</h1>
    <p class="note">Выберите даты и нажмите «Рассчитать». По умолчанию запрос уходит на <code>/costs/recalculate</code> методом <code>POST</code> с query‑параметрами <code>start_date</code> и <code>end_date</code>.</p>

    <form id="form">
      <label>
        Начало периода
        <input id="from" type="date" required />
      </label>
      <label>
        Конец периода
        <input id="to" type="date" required />
      </label>
      <button id="run" type="submit">Рассчитать</button>
    </form>


    <div class="row">
      <div id="status" class="small"></div>
      <div id="out" class="out" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // ===== НАСТРОЙКА =====
    // Относительный путь, если фронтенд отдаётся тем же хостом, что и backend
    // Если API на другом хосте/порту, укажи полный URL, например:
    // const API_URL = "http://localhost:8000/api/calc";
    // const API_URL = "http://localhost:8000/costs/recalculate";
    const API_URL = "/costs/recalculate";


    const form = document.getElementById('form');
    const runBtn = document.getElementById('run');
    const out = document.getElementById('out');
    const statusEl = document.getElementById('status');
    const from = document.getElementById('from');
    const to = document.getElementById('to');

    // Значения по умолчанию: сегодня и сегодня
    const today = new Date();
    const pad = n => String(n).padStart(2, '0');
    const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    from.value = fmt(today);
    to.value = fmt(today);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      out.textContent = '';
      statusEl.textContent = '';

      const date_from = from.value;
      const date_to = to.value;

      if (!date_from || !date_to) {
        statusEl.textContent = 'Заполните обе даты.';
        statusEl.className = 'small err';
        return;
      }
      if (date_from > date_to) {
        statusEl.textContent = 'Дата начала не может быть позже даты конца.';
        statusEl.className = 'small err';
        return;
      }

      runBtn.disabled = true;
      const oldText = runBtn.textContent;
      runBtn.textContent = 'Считаю…';

      try {
        const url = `${API_URL}?start_date=${encodeURIComponent(date_from)}&end_date=${encodeURIComponent(date_to)}`;
        const res = await fetch(url, { method: 'POST' });

        const text = await res.text();
        let payload;
        try { payload = JSON.parse(text); } catch (_) { payload = text; }

        if (!res.ok) {
          statusEl.textContent = `Ошибка HTTP ${res.status}`;
          statusEl.className = 'small err';
          out.textContent = typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2);
          return;
        }

        statusEl.textContent = 'Готово';
        statusEl.className = 'small ok';
        out.textContent = typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2);
      } catch (err) {
        statusEl.textContent = 'Сетевая ошибка';
        statusEl.className = 'small err';
        out.textContent = String(err);
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = oldText;
      }
    });
  </script>
</body>
</html>
